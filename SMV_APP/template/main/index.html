<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Información Financiera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.5.0/css/all.css'>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f4ff',
                            100: '#e0e8ff',
                            500: '#667eea',
                            600: '#5a6fd8',
                            700: '#4c5bc6'
                        }
                    },
                    backgroundImage: {
                        'gradient-primary': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'gradient-secondary': 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                        'gradient-warning': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'gradient-info': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'gradient-success': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        'gradient-stat4': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados adicionales */
        .checkbox-item input[type="checkbox"] {
            accent-color: #667eea;
        }

        .modal {
            backdrop-filter: blur(5px);
        }

        .excel-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .radio-item input[type="radio"] {
            accent-color: #667eea;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-500 to-purple-700 min-h-screen p-5 text-gray-800">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="header bg-white text-center mb-8 p-8 rounded-2xl shadow-xl">
            <h1
                class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
                <i class="fas fa-chart-line mr-2"></i> Panel de Control Financiero
            </h1>
            <p class="text-gray-600 text-lg">Extracción y análisis de información empresarial</p>
        </div>

        <!-- Dashboard Grid - Ahora en 2 filas -->
        <div class="flex flex-col gap-6">
            <!-- Control Panel - Ahora arriba -->
            <div class="control-panel bg-white rounded-2xl p-8 shadow-xl">
                <h2 class="section-title text-xl font-semibold mb-5 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-cogs"></i> Configuración
                </h2>

                <form id="searchForm" onsubmit="handleSearch(event)">
                    <!-- Selección de Empresa -->
                    <div class="mb-5">
                        <label for="company-select" class="form-label block text-gray-700 font-semibold mb-2 text-sm">
                            <i class="fas fa-building mr-1"></i> Empresa:
                        </label>
                        <select id="company-select"
                            class="w-full p-3 border-2 border-gray-200 rounded-xl text-gray-700 bg-gray-50 focus:outline-none focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 transition-all"
                            required>
                            <option value="">Seleccione una empresa</option>
                            <!-- Todas las opciones se cargarán dinámicamente -->
                        </select>
                    </div>

                    
                <!-- Filtros por Rubro -->
                <div class="mb-6">
                    <label class="form-label block text-gray-700 font-semibold mb-3 text-sm">
                        <i class="fas fa-filter mr-1"></i> Filtrar por Rubro:
                    </label>
                    <div class="radio-grid grid grid-cols-2 md:grid-cols-4 gap-3" id="rubroFilters">
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="todos" checked class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Todos</span>
                        </label>
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="bancos" class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Bancos</span>
                        </label>
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="seguros" class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Seguros</span>
                        </label>
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="mineria" class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Minería</span>
                        </label>
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="energia" class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Energía</span>
                        </label>
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="industria" class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Industria</span>
                        </label>
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="agro" class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Agroindustria</span>
                        </label>
                        <label
                            class="radio-item bg-gray-50 p-3 rounded-xl cursor-pointer border-2 border-gray-200 hover:border-blue-300 transition-all flex items-center gap-2">
                            <input type="radio" name="rubro" value="servicios" class="rubro-radio">
                            <span class="radio-label text-sm font-medium">Servicios</span>
                        </label>
                    </div>
                </div>

                    <!-- Botones de Acción -->
                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <button type="submit"
                            class="btn bg-gradient-primary text-white p-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all hover:-translate-y-0.5 hover:shadow-lg">
                            <i class="fas fa-search"></i> Extraer Datos
                        </button>
                        <button type="button" id="btnAnalisis"
                            class="btn bg-gradient-secondary text-white p-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all hover:-translate-y-0.5 hover:shadow-lg"
                            onclick="analisis()">
                            <i class="fas fa-file-excel"></i> Analisis
                        </button>
                    </div>

                </form>

                <!-- Barra de Progreso -->
                <div class="progress-container bg-gray-100 rounded-xl overflow-hidden h-2 my-5 hidden"
                    id="progressContainer">
                    <div class="progress-bar h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl w-0 transition-all"
                        id="progressBar"></div>
                </div>

                <!-- Indicador de Estado -->
                <div id="statusIndicator"></div>

                <!-- Estadísticas -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 my-6">
                    <div class="stat-card bg-gradient-warning text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="totalFiles">0</div>
                        <div class="stat-label text-sm opacity-90">Archivos Extraídos</div>
                    </div>
                    <div class="stat-card bg-gradient-info text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="totalSize">0 MB</div>
                        <div class="stat-label text-sm opacity-90">Tamaño Total</div>
                    </div>
                    <div class="stat-card bg-gradient-success text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="successRate">0%</div>
                        <div class="stat-label text-sm opacity-90">Tasa de Éxito</div>
                    </div>
                    <div class="stat-card bg-gradient-stat4 text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="processingTime">0s</div>
                        <div class="stat-label text-sm opacity-90">Tiempo Proceso</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="mb-5">
                    <label class="form-label block text-gray-700 font-semibold mb-2 text-sm">
                        <i class="fas fa-terminal mr-1"></i> Registro de Actividad:
                    </label>
                    <div class="logs-container bg-gray-50 rounded-xl p-4 max-h-40 overflow-y-auto" id="logsContainer">
                        <div class="log-entry text-sm py-1 border-b border-gray-200 text-gray-700">
                            <span class="log-time text-gray-500 mr-2">12:00:00</span>
                            Sistema iniciado correctamente
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel - Ahora abajo -->
            <div class="results-panel bg-white rounded-2xl p-8 shadow-xl min-h-[500px]">
                <h2 class="section-title text-xl font-semibold mb-5 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-folder-open"></i> Archivos Extraídos
                </h2>

                <div id="filesList" class="file-list">
                    <!-- Los archivos se mostrarán aquí dinámicamente -->
                    <div class="text-center py-16 text-gray-500">
                        <i class="fas fa-inbox text-5xl mb-5 opacity-50"></i>
                        <p>No hay archivos extraídos aún</p>
                        <p class="text-sm mt-2">Seleccione una empresa y configure los parámetros de extracción</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Vista Previa de Excel -->
    <div id="excelModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div
            class="modal-content bg-white p-8 rounded-2xl shadow-2xl absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-6xl max-h-[90vh] overflow-auto">
            <div class="modal-header flex justify-between items-center mb-5 pb-3 border-b border-gray-200">
                <h3 class="text-xl font-semibold"><i class="fas fa-file-excel mr-2"></i> Vista Previa - <span
                        id="modalFileName"></span></h3>
                <button
                    class="close-modal bg-transparent border-none text-gray-500 text-2xl cursor-pointer w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-100 hover:text-gray-700 transition-colors"
                    onclick="closeModal()">&times;</button>
            </div>
            <div class="excel-preview overflow-auto max-h-96 border border-gray-200 rounded-lg" id="excelPreview">
                <!-- Contenido del Excel se cargará aquí -->
            </div>
        </div>
    </div>

    <script>
        // Datos de empresas categorizadas por rubro
        const empresasPorRubro = {
            bancos: [
                "BANCO BBVA PERU",
                "BANCO BCI PERU S.A. - BANCO BCI",
                "BANCO DE COMERCIO",
                "BANCO DE CREDITO DEL PERU",
                "BANCO DE LA NACION",
                "BANCO FALABELLA PERU S.A.",
                "BANCO GNB PERU S.A.",
                "BANCO INTERAMERICANO DE FINANZAS",
                "BANCO INTERNACIONAL DEL PERU S.A.A. - INTERBANK",
                "BANCO PICHINCHA",
                "BANCO RIPLEY PERU S.A.",
                "BANCO SANTANDER PERU S.A.",
                "BANK OF CHINA (PERU) S.A.",
                "COMPARTAMOS BANCO S.A.",
                "ICBC PERU BANK",
                "MIBANCO BANCO DE LA MICROEMPRESA S.A.",
                "SCOTIABANK PERU S.A.A."
            ],
            seguros: [
                "AVLA PERU COMPAÑIA DE SEGUROS S.A.",
                "BNP PARIBAS CARDIF S.A. COMPAÑIA DE SEGUROS Y REASEGUROS",
                "CESCE PERU S.A. COMPAÑIA DE SEGUROS",
                "CHUBB PERU S.A. COMPAÑIA DE SEGUROS Y REASEGUROS",
                "CRECER SEGUROS S.A. COMPANIA DE SEGUROS",
                "INSUR S.A. COMPAÑIA DE SEGUROS",
                "INTERSEGURO COMPAÑIA DE SEGUROS S.A.",
                "LA POSITIVA SEGUROS Y REASEGUROS S.A.",
                "LA POSITIVA VIDA SEGUROS Y REASEGUROS S.A.",
                "LIBERTY SEGUROS S.A.",
                "MAPFRE PERU COMPAÑIA DE SEGUROS Y REASEGUROS",
                "OHIO NATIONAL SEGUROS DE VIDA Y REASEGUROS S.A.",
                "PACIFICO COMPAÑIA DE SEGUROS Y REASEGUROS",
                "PROTECTA S.A. COMPAÑIA DE SEGUROS Y REASEGUROS",
                "QUALITAS COMPAÑIA DE SEGUROS S.A.",
                "RIMAC SEGUROS Y REASEGUROS",
                "VIVIR SEGUROS COMPAÑIA DE SEGUROS DE VIDA S.A."
            ],
            mineria: [
                "ALTA COPPER CORP.",
                "BEAR CREEK MINING CORPORATION",
                "CASTROVIRREYNA COMPAÑIA MINERA S.A. EN LIQUIDACION",
                "CERRO DE PASCO RESOURCES INC.",
                "COMPAÑIA DE MINAS BUENAVENTURA S.A.A.",
                "COMPAÑIA MINERA PODEROSA S.A.",
                "COMPAÑIA MINERA SAN IGNACIO DE MOROCOCHA S.A.A.",
                "COMPAÑIA MINERA SANTA LUISA S.A.",
                "ELEMENT 29 RESOURCES INC.",
                "MINERA ANDINA DE EXPLORACIONES S.A.A.",
                "MINERA IRL LIMITED",
                "MINSUR S.A.",
                "NEXA RESOURCES ATACOCHA S.A.A.",
                "NEXA RESOURCES PERU S.A.A.",
                "PANORO MINERALS LTD.",
                "PERUBAR S.A.",
                "PPX MINING CORP.",
                "REGULUS RESOURCES INC.",
                "RIO2 LIMITED",
                "SILVER MOUNTAIN RESOURCES INC.",
                "SOCIEDAD MINERA CERRO VERDE S.A.A.",
                "SOCIEDAD MINERA CORONA S.A.",
                "SOCIEDAD MINERA EL BROCAL S.A.A.",
                "SOUTHERN PERU COPPER CORPORATION, SUCURSAL DEL PERU",
                "VOLCAN COMPAÑIA MINERA S.A.A."
            ],
            energia: [
                "DUNAS ENERGIA S.A.A.",
                "ELECTRO DUNAS S.A.A.",
                "ELECTRO SUR ESTE S.A.A.",
                "EMPRESA DE GENERACION ELECTRICA DEL SUR S.A.",
                "EMPRESA DE GENERACION ELECTRICA SAN GABAN S.A.",
                "EMPRESA ELECTRICIDAD DEL PERU - ELECTROPERU S.A.",
                "EMPRESA REGIONAL DE SERVICIO PUBLICO DE ELECTRICIDAD - ELECTROSUR S.A.",
                "EMPRESA REGIONAL DE SERVICIO PUBLICO DE ELECTRICIDAD DE PUNO S.A.A. - ELECTROPUNO",
                "EMPRESA REGIONAL DE SERVICIO PUBLICO DE ELECTRICIDAD ELECTRONORTE MEDIO S.A. - HIDRANDINA",
                "ENEL GENERACION PIURA S.A.",
                "ENERGIA DEL PACIFICO S.A.",
                "ENGIE ENERGIA PERU S.A.A.",
                "LUZ DEL SUR S.A.A.",
                "ORYGEN PERU S.A.A.",
                "PERUANA DE ENERGIA S.A.A.",
                "PLUZ ENERGIA PERU S.A.A.",
                "RED DE ENERGIA DEL PERU S.A.",
                "SHOUGANG GENERACION ELECTRICA S.A.A."
            ],
            industria: [
                "ALICORP S.A.A.",
                "AUSTRAL GROUP S.A.A.",
                "CEMENTOS PACASMAYO S.A.A.",
                "CORPORACION ACEROS AREQUIPA S.A.",
                "EMPRESA SIDERURGICA DEL PERU S.A.A. - SIDERPERU",
                "FABRICA NACIONAL DE ACUMULADORES ETNA S.A.",
                "FABRICA PERUANA ETERNIT S.A.",
                "FERREYCORP S.A.A.",
                "FILAMENTOS INDUSTRIALES S.A.",
                "HIDROSTAL S.A.",
                "INDUSTRIAS ELECTRO QUIMICAS S.A. IEQSA",
                "LAIVE S.A.",
                "LECHE GLORIA S.A.",
                "MANUFACTURA DE METALES Y ALUMINIO RECORD S.A.",
                "MICHELL Y CIA. S.A.",
                "QUIMPAC S.A.",
                "REFINERIA LA PAMPILLA S.A.A.",
                "TEXTIL SAN CRISTOBAL S.A. - EN LIQUIDACION",
                "UNACEM CORP SOCIEDAD ANONIMA ABIERTA - UNACEM CORP S.A.A.",
                "UNION DE CERVECERIAS PERUANAS BACKUS Y JOHNSTON S.A.A.",
                "YURA S.A."
            ],
            agro: [
                "AGRICOLA CAYALTI SOCIEDAD ANONIMA ABIERTA",
                "AGRO INDUSTRIAL PARAMONGA S.A.",
                "AGRO PUCALA S.A.A.",
                "AGROINDUSTRIAL LAREDO S.A.A.",
                "AGROINDUSTRIAS AIB S.A.",
                "AGROINDUSTRIAS SAN JACINTO S.A.A.",
                "CARTAVIO SOCIEDAD ANONIMA ABIERTA",
                "CASA GRANDE SOCIEDAD ANONIMA ABIERTA",
                "CENTRAL AZUCARERA CHUCARAPI-PAMPA BLANCA S.A.",
                "EMPRESA AGRARIA AZUCARERA ANDAHUASI S.A.A.",
                "EMPRESA AGRARIA CHIQUITOY S.A.",
                "EMPRESA AGRICOLA GANADERA SALAMANCA S.A.A.",
                "EMPRESA AGRICOLA LA UNION S.A.",
                "EMPRESA AGRICOLA SAN JUAN S.A.",
                "EMPRESA AGROINDUSTRIAL POMALCA S.A.A.",
                "EMPRESA AGROINDUSTRIAL TUMAN S.A.A.",
                "EMPRESA AZUCARERA EL INGENIO S.A.",
                "PESQUERA EXALMAR S.A.A.",
                "SOCIEDAD AGRICOLA FANUPE VICHAYAL S.A."
            ],
            servicios: [
                "ADMINISTRADORA DEL COMERCIO S.A.",
                "ADMINISTRADORA JOCKEY PLAZA SHOPPING CENTER S.A.",
                "AENZA S.A.A.",
                "AFP HABITAT S.A.",
                "AFP INTEGRA",
                "AI INVERSIONES PALO ALTO S.A.",
                "ALFIN BANCO S.A.",
                "ANDINO INVESTMENT HOLDING S.A.A.",
                "AUNA S.A.",
                "AZZARO TRADING S.A.",
                "BOSQUES AMAZONICOS S.A.",
                "CAJA MUNICIPAL DE AHORRO Y CREDITO CUSCO S.A. - CMAC CUSCO S.A.",
                "CAJA MUNICIPAL DE AHORRO Y CREDITO DE AREQUIPA S.A.",
                "CAJA MUNICIPAL DE AHORRO Y CREDITO DE HUANCAYO S.A.",
                "CAJA RURAL DE AHORRO Y CREDITO LOS ANDES S.A.",
                "CERVECERIA SAN JUAN S.A.",
                "CITIBANK DEL PERU S.A.",
                "COMPAÑIA UNIVERSAL TEXTIL S.A. EN LIQUIDACION",
                "CONCESIONARIA TRASVASE OLMOS S.A.",
                "CONSORCIO CEMENTERO DEL SUR S.A.",
                "COPEN INVERSIONES S.A.",
                "CORPORACION CERVESUR S.A.A.",
                "CORPORACION FINANCIERA DE DESARROLLO S.A. - COFIDE",
                "COSAPI S.A.",
                "CREDICORP CAPITAL PERU S.A.A.",
                "CREDICORP LTD.",
                "CREDITEX S.A.A.",
                "DESARROLLOS SIGLO XXI S.A.A.",
                "DIVISO GRUPO FINANCIERO S.A.",
                "EMPRESA DE CREDITOS SANTANDER CONSUMO PERU S.A.",
                "EMPRESA EDITORA EL COMERCIO S.A.",
                "EXPERTIA TRAVEL S.A.",
                "FACTOTAL PERU S.A.",
                "FALABELLA PERU S.A.A.",
                "FINANCIERA CONFIANZA S.A.A.",
                "FINANCIERA CREDINKA S.A. EN LIQUIDACION",
                "FINANCIERA EFECTIVA S.A.",
                "FINANCIERA OH! S.A.",
                "FINANCIERA PROEMPRESA S.A.",
                "FINANCIERA QAPAQ S.A.",
                "FINANCIERA TFC S.A. EN LIQUIDACION",
                "FONDO MIVIVIENDA S.A.",
                "FOSFATOS DEL PACIFICO S.A.",
                "FOSSAL S.A.A.",
                "FUTURA CONSORCIO INMOBILIARIO S.A.",
                "GR HOLDING S.A.",
                "GRUPO BVL S.A.A.",
                "HERMES TRANSPORTES BLINDADOS S.A.",
                "HOLDING BURSATIL REGIONAL S.A.",
                "H2OLMOS S.A.",
                "INCA RAIL S.A.",
                "INDECO S.A.",
                "INDUSTRIA TEXTIL PIURA S.A.",
                "INMOBILIARIA IDE S.A.",
                "INMOBILIARIA SIC S.A.",
                "INRETAIL PERU CORP.",
                "INTEGRATEL PERU S.A.A. (ANTES TELEFONICA DEL PERU S.A.A.)",
                "INTERCORP FINANCIAL SERVICES INC.",
                "INVERFAL PERU S.A.A.",
                "INVERPERU INMOBILIARIA S.A.A.",
                "INVERSIONES CENTENARIO S.A.A.",
                "INVERSIONES CORPORATIVAS A1 S.A. - INVERCORP A1 S.A.",
                "INVERSIONES EN TURISMO S.A. INVERTUR",
                "INVERSIONES PORTUARIAS CHANCAY S.A.A.",
                "J.P. MORGAN BANCO DE INVERSION",
                "LOS PORTALES S.A.",
                "MITSUI AUTO FINANCE PERU S.A.",
                "PERU HOLDING DE TURISMO S.A.A.",
                "PETROLEOS DEL PERU - PETROPERU S.A.",
                "PRIMA AFP S.A.",
                "PROFUTURO AFP",
                "PROMOINVEST SOCIEDAD ADMINISTRADORA DE FONDOS S.A.A.",
                "PROMOTORA CLUB EMPRESARIAL S.A.",
                "PVT PORTAFOLIO DE VALORES S.A.",
                "RED BICOLOR DE COMUNICACIONES S.A.A. - RBC TV S.A.A.",
                "RED VIAL 5 S.A.",
                "SAGA FALABELLA S.A.",
                "SANTANDER CONSUMER BANK S.A.",
                "SANTANDER FINANCIAMIENTOS S.A.",
                "SERVICIO DE AGUA POTABLE Y ALCANTARILLADO - SEDAPAL",
                "SHOUGANG HIERRO PERU S.A.A.",
                "SOLUCION EMPRESA ADMINISTRADORA HIPOTECARIA S.A.",
                "STRACON HOLDINGS S.A.",
                "TC SIGLO 21 S.A.A.",
                "TOTAL SERVICIOS FINANCIEROS EMPRESA DE CREDITOS",
                "TRADI S.A."
            ]
        };

        // Función para inicializar el select con todas las empresas
        function inicializarSelectEmpresas() {
            const select = document.getElementById('company-select');
            select.innerHTML = '<option value="">Seleccione una empresa</option>';

            // Obtener todas las empresas únicas
            const todasLasEmpresas = new Set();
            Object.values(empresasPorRubro).forEach(empresas => {
                empresas.forEach(empresa => todasLasEmpresas.add(empresa));
            });

            // Ordenar alfabéticamente y agregar al select
            Array.from(todasLasEmpresas).sort().forEach(empresa => {
                const option = document.createElement('option');
                option.value = empresa;
                option.textContent = empresa;
                select.appendChild(option);
            });
        }

        // Función para filtrar empresas según el rubro seleccionado
        function filtrarEmpresasPorRubro(rubro) {
            const select = document.getElementById('company-select');
            const valorActual = select.value;

            select.innerHTML = '<option value="">Seleccione una empresa</option>';

            let empresasAFiltrar;
            if (rubro === 'todos') {
                // Obtener todas las empresas únicas
                const todasLasEmpresas = new Set();
                Object.values(empresasPorRubro).forEach(empresas => {
                    empresas.forEach(empresa => todasLasEmpresas.add(empresa));
                });
                empresasAFiltrar = Array.from(todasLasEmpresas);
            } else {
                empresasAFiltrar = empresasPorRubro[rubro] || [];
            }

            // Ordenar y agregar empresas filtradas
            empresasAFiltrar.sort().forEach(empresa => {
                const option = document.createElement('option');
                option.value = empresa;
                option.textContent = empresa;
                select.appendChild(option);
            });

            // Mantener el valor seleccionado si todavía está disponible
            if (empresasAFiltrar.includes(valorActual)) {
                select.value = valorActual;
            }
        }

        // Event listeners para los radio buttons
        document.addEventListener('DOMContentLoaded', function () {
            inicializarSelectEmpresas();
            cargarSeleccionDesdeLocalStorage();

            // Agregar event listeners a los radio buttons
            document.querySelectorAll('input[name="rubro"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    filtrarEmpresasPorRubro(this.value);
                });
            });

            // Estilo visual para radio buttons seleccionados
            document.querySelectorAll('.rubro-radio').forEach(radio => {
                radio.addEventListener('change', function () {
                    // Remover estilos de todos
                    document.querySelectorAll('.radio-item').forEach(item => {
                        item.classList.remove('border-blue-500', 'bg-blue-50');
                        item.classList.add('border-gray-200', 'bg-gray-50');
                    });

                    // Aplicar estilos al seleccionado
                    if (this.checked) {
                        const parent = this.closest('.radio-item');
                        parent.classList.remove('border-gray-200', 'bg-gray-50');
                        parent.classList.add('border-blue-500', 'bg-blue-50');
                    }
                });
            });

            // Aplicar estilo inicial al radio "Todos"
            const radioTodos = document.querySelector('input[value="todos"]');
            if (radioTodos.checked) {
                const parent = radioTodos.closest('.radio-item');
                parent.classList.remove('border-gray-200', 'bg-gray-50');
                parent.classList.add('border-blue-500', 'bg-blue-50');
            }

        });

        function guardarSeleccionEnLocalStorage() {
            const empresaSeleccionada = document.getElementById('company-select').value;
            const rubroSeleccionado = document.querySelector('input[name="rubro"]:checked').value;

            const seleccion = {
                empresa: empresaSeleccionada,
                rubro: rubroSeleccionado,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('ultimaSeleccionEmpresa', JSON.stringify(seleccion));
            console.log('Selección guardada en localStorage:', seleccion);
        }

        // Función para cargar la última selección desde localStorage
        function cargarSeleccionDesdeLocalStorage() {
            const seleccionGuardada = localStorage.getItem('ultimaSeleccionEmpresa');

            if (seleccionGuardada) {
                try {
                    const seleccion = JSON.parse(seleccionGuardada);

                    // Restaurar el rubro seleccionado
                    const radioRubro = document.querySelector(`input[name="rubro"][value="${seleccion.rubro}"]`);
                    if (radioRubro) {
                        radioRubro.checked = true;
                        // Disparar el evento change para filtrar las empresas
                        radioRubro.dispatchEvent(new Event('change'));
                    }

                    // Restaurar la empresa seleccionada después de que se carguen las opciones
                    setTimeout(() => {
                        const selectEmpresa = document.getElementById('company-select');
                        if (seleccion.empresa && Array.from(selectEmpresa.options).some(opt => opt.value === seleccion.empresa)) {
                            selectEmpresa.value = seleccion.empresa;
                            addLog(`Selección restaurada: ${seleccion.empresa} (${seleccion.rubro})`);

                            // Cargar archivos existentes para la empresa restaurada
                            if (seleccion.empresa) {
                                loadExistingFiles(seleccion.empresa);
                            }
                        }
                    }, 100);

                } catch (error) {
                    console.error('Error al cargar selección desde localStorage:', error);
                }
            }
        }

        // Función actualizada para controlar el estado del botón de análisis
        function updateAnalisisBtnState() {
            const companySelect = document.getElementById('company-select');
            const btnAnalisis = document.getElementById('btnAnalisis');
            const empresaSeleccionada = companySelect.value;

            if (!empresaSeleccionada) {
                btnAnalisis.disabled = true;
                btnAnalisis.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            const archivosEmpresa = extractedFiles.filter(f => f.company === empresaSeleccionada);
            const tiene5Archivos = archivosEmpresa.length === 5;

            console.log(`Archivos para ${empresaSeleccionada}:`, archivosEmpresa.length);
            console.log('Detalle de archivos:', archivosEmpresa.map(f => f.name));

            btnAnalisis.disabled = !tiene5Archivos;
            btnAnalisis.classList.toggle('opacity-50', !tiene5Archivos);
            btnAnalisis.classList.toggle('cursor-not-allowed', !tiene5Archivos);

            if (tiene5Archivos) {
                btnAnalisis.title = 'Listo para análisis - Se encontraron 5 archivos';
                addLog(`✅ ${empresaSeleccionada} tiene 5 archivos - Análisis habilitado`);
            } else {
                btnAnalisis.title = `Se necesitan 5 archivos para análisis (actual: ${archivosEmpresa.length})`;
            }
        }


        function limpiarSeleccionStorage() {
            localStorage.removeItem('ultimaSeleccionEmpresa');
            console.log('Selección limpiada de localStorage');
        }

        // Función para verificar el estado actual del localStorage
        function verificarEstadoStorage() {
            const seleccion = localStorage.getItem('ultimaSeleccionEmpresa');
            console.log('Estado actual del localStorage:', seleccion);
            return seleccion ? JSON.parse(seleccion) : null;
        }
        // Variables globales
        let extractedFiles = [];
        let currentExtractionId = null;
        let processingStartTime = null;
        let progressInterval = null;
        let currentDownloadPath = '';

        // Función principal de extracción
        function handleSearch(event) {
            event.preventDefault();

            const formData = getFormData();
            if (!validateFormData(formData)) return;

            startExtraction(formData);
        }

        // Recopilar datos del formulario
        function getFormData() {
            const companySelect = document.getElementById('company-select');
            const selectedOption = companySelect.options[companySelect.selectedIndex];

            return {
                company: companySelect.value,
                companyName: selectedOption.text,
            };
        }

        /* function updateAnalisisBtnState() {
             const companySelect = document.getElementById('company-select');
             const btnAnalisis = document.getElementById('btnAnalisis');
             console.log('Archivos extraídos:', extractedFiles.filter(f => f.company === companySelect.value).length);
             btnAnalisis.disabled = extractedFiles.filter(f => f.company === companySelect.value).length !== 5;
             btnAnalisis.classList.toggle('opacity-50', extractedFiles.filter(f => f.company === companySelect.value).length !== 5);
         } */



        // Validar datos del formulario
        function validateFormData(data) {
            if (!data.company) {
                showStatus('Por favor seleccione una empresa', 'error');
                return false;
            }
            return true;
        }

        // Iniciar proceso de extracción
        function startExtraction(data) {
            processingStartTime = Date.now();
            currentExtractionId = generateId();

            showProgress(true);
            updateProgress(0);
            showStatus('Iniciando extracción de datos...', 'info');
            addLog('Iniciando extracción para: ' + data.companyName);

            // Configurar path de descarga esperado
            const companyClean = data.companyName.replace(/[^a-zA-Z0-9\s\-_]/g, '').replace(/\s+/g, '_');
            currentDownloadPath = `descargas_smv/${companyClean}`;
            if (!currentDownloadPath.exists) {
                addLog('Error: Ruta de descarga inválida');
            }
            console.log('Path de descarga configurado:', currentDownloadPath);

            // Iniciar monitoreo de progreso
            startProgressMonitoring();

            // Llamar a la función Django via AJAX
            callDjangoExtraction(data);
        }

        // Monitoreo de progreso en tiempo real
        function startProgressMonitoring() {
            let progress = 0;
            const progressSteps = [10, 25, 40, 55, 70, 85];
            let currentStep = 0;

            progressInterval = setInterval(() => {
                if (currentStep < progressSteps.length) {
                    progress = progressSteps[currentStep];
                    updateProgress(progress);

                    // Mensajes de progreso
                    const messages = [
                        'Conectando con SMV...',
                        'Navegando a la página de empresas...',
                        'Buscando empresa...',
                        'Accediendo a información financiera...',
                        'Descargando archivos...',
                        'Procesando documentos...'
                    ];

                    if (currentStep < messages.length) {
                        showStatus(messages[currentStep], 'info');
                        addLog(messages[currentStep]);
                    }

                    currentStep++;
                }

                // Verificar archivos en tiempo real
                checkForNewFiles();

            }, 1000); // Verificar cada 1 segundos
        }

        // Verificar nuevos archivos en la carpeta
        async function checkForNewFiles() {
            if (!currentDownloadPath) return;

            try {
                const response = await fetch('/verificar-archivos/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        path: currentDownloadPath
                    })
                });

                const data = await response.json();

                if (data.archivos) {
                    const companySelect = document.getElementById('company-select');
                    const selectedCompany = companySelect.options[companySelect.selectedIndex].text;

                    data.archivos.forEach(archivo => {
                        const exists = extractedFiles.some(f => f.path === archivo.ruta);
                        if (!exists) {
                            const file = {
                                id: generateId(),
                                name: archivo.nombre,
                                type: 'excel',
                                size: archivo.tamaño || 0,
                                date: new Date(archivo.fecha || Date.now()),
                                company: selectedCompany,
                                format: 'excel',
                                status: 'completed',
                                path: archivo.ruta,
                                year: archivo.año || extractYearFromFilename(archivo.nombre)
                            };

                            extractedFiles.push(file);
                            addLog(`Archivo encontrado: ${file.name}`);
                            displayFiles();
                            updateStats();
                            updateAnalisisBtnState();
                        }
                    });
                }

            } catch (error) {
                console.error('Error verificando archivos:', error);
            }
        }

        // Extraer año del nombre del archivo
        function extractYearFromFilename(filename) {
            const yearMatch = filename.match(/(\d{4})/);
            return yearMatch ? parseInt(yearMatch[1]) : null;
        }

        // Llamar a la función Django
        function callDjangoExtraction(data) {
            fetch('/descargar-datos-financieros/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    empresa_nombre: data.companyName,
                    anios: data.anios
                })
            })
                .then(response => response.json())
                .then(resultado => {
                    if (resultado.error) {
                        throw new Error(resultado.error);
                    }
                    console.log('Extracción completada:', resultado);
                    finishExtraction(data, resultado);
                })
                .catch(error => {
                    console.error('Error en la extracción:', error);
                    showStatus('Error en la extracción: ' + error.message, 'error');
                    addLog('Error: ' + error.message);
                    showProgress(false);
                    clearInterval(progressInterval);
                });
        }

        // Obtener token CSRF
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Finalizar extracción
        function finishExtraction(data, resultado) {
            clearInterval(progressInterval);

            const processingTime = Math.round((Date.now() - processingStartTime) / 1000);

            // Procesar archivos del resultado
            if (resultado.archivos && resultado.archivos.length > 0) {
                resultado.archivos.forEach((archivo) => {
                    const file = {
                        id: generateId(),
                        name: archivo.nombre,
                        type: archivo.tipo || 'excel',
                        size: archivo.tamaño || 0,
                        date: new Date(archivo.fecha || Date.now()),
                        company: data.companyName,
                        format: 'excel',
                        status: 'completed',
                        path: archivo.ruta || '',
                        year: archivo.año || extractYearFromFilename(archivo.nombre)
                    };

                    // Evitar duplicados
                    const exists = extractedFiles.some(f => f.path === file.path);
                    if (!exists) {
                        extractedFiles.push(file);
                    }
                });
            }
            checkForNewFiles();

            updateProgress(100);
            showStatus(`Extracción completada. ${extractedFiles.filter(f => f.company === data.companyName).length} archivos extraídos exitosamente.`, 'success');
            addLog(`Proceso completado en ${processingTime} segundos`);

            // Actualizar estadísticas
            updateStats();
            // Mostrar archivos
            displayFiles();

            // Ocultar progreso después de un momento
            setTimeout(() => showProgress(false), 2000);

            // Actualizar tiempo de procesamiento
            document.getElementById('processingTime').textContent = processingTime + 's';
        }

        // Cargar archivos existentes de una empresa
        async function loadExistingFiles(companyName) {
            const companyClean = companyName
            .replace(/[^a-zA-Z0-9áéíóúüÁÉÍÓÚÜñÑ\s\-_]/g, '')  
            .replace(/\s+/g, '_');
            console.log('Cargando archivos existentes para:', companyName, 'en ruta:', companyClean);
            currentDownloadPath = `descargas_smv/${companyClean}`;

            try {
                addLog(`Verificando archivos existentes para: ${companyName}`);

                const response = await fetch('/verificar-archivos/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        path: currentDownloadPath
                    })
                });

                const data = await response.json();

                if (data.archivos && data.archivos.length > 0) {
                    // Limpiar archivos existentes de esta empresa
                    extractedFiles = extractedFiles.filter(f => f.company !== companyName);

                    data.archivos.forEach(archivo => {
                        const file = {
                            id: generateId(),
                            name: archivo.nombre,
                            type: 'excel',
                            size: archivo.tamaño || 0,
                            date: new Date(archivo.fecha || Date.now()),
                            company: companyName,
                            format: 'excel',
                            status: 'completed',
                            path: archivo.ruta,
                            year: archivo.año || extractYearFromFilename(archivo.nombre)
                        };

                        extractedFiles.push(file);
                    });

                    addLog(`${data.archivos.length} archivos encontrados para ${companyName}`);
                } else {
                    addLog(`No se encontraron archivos para ${companyName}`);
                }

                displayFiles();
                updateStats();
                updateAnalisisBtnState();
            } catch (error) {
                console.error('Error cargando archivos existentes:', error);
                addLog('Error al cargar archivos existentes: ' + error.message);
                updateAnalisisBtnState();
            }
        }

        // Mostrar archivos en la interfaz
        function displayFiles() {
            const container = document.getElementById('filesList');

            if (extractedFiles.length === 0) {
                container.innerHTML = `
            <div class="text-center py-16 text-gray-500">
                <i class="fas fa-inbox text-5xl mb-5 opacity-50"></i>
                <p>No hay archivos extraídos aún</p>
                <p class="text-sm mt-2">Seleccione una empresa y configure los parámetros de extracción</p>
            </div>
        `;
                return;
            }

            // Filtrar archivos por la empresa seleccionada
            const companySelect = document.getElementById('company-select');
            const selectedCompany = companySelect.options[companySelect.selectedIndex].text;
            const filteredFiles = extractedFiles.filter(file => file.company === selectedCompany);

            if (filteredFiles.length === 0) {
                container.innerHTML = `
            <div class="text-center py-16 text-gray-500">
                <i class="fas fa-inbox text-5xl mb-5 opacity-50"></i>
                <p>No hay archivos para ${selectedCompany}</p>
                <p class="text-sm mt-2">Realice una extracción para esta empresa</p>
            </div>
        `;
                return;
            }

            // Ordenar archivos por año (más reciente primero)
            const sortedFiles = filteredFiles.sort((a, b) => (b.year || 0) - (a.year || 0));

            const filesHtml = sortedFiles.map(file => `
        <div class="file-item bg-gray-50 rounded-lg p-4 mb-3 flex justify-between items-center">
            <div class="file-info flex items-center gap-3">
                <div class="file-icon text-green-600 text-2xl">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="file-details">
                    <h4 class="font-semibold text-gray-800">${file.name}</h4>
                    <p class="text-sm text-gray-600">
                        ${file.company} • ${formatFileSize(file.size)} • ${formatDate(file.date)}
                        ${file.year ? ` • Año ${file.year}` : ''}
                    </p>
                    <p class="text-xs text-gray-500">${file.path}</p>
                </div>
            </div>
            <div class="file-actions flex gap-2">
                <button class="btn bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600 transition-colors" onclick="previewFile('${file.id}')">
                    <i class="fas fa-eye"></i> Ver
                </button>
                <button class="btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors" onclick="downloadFile('${file.id}')">
                    <i class="fas fa-download"></i> Descargar
                </button>
            </div>
        </div>
    `).join('');

            container.innerHTML = filesHtml;
        }

        // Vista previa de archivo
        function previewFile(fileId) {
            const file = extractedFiles.find(f => f.id === fileId);
            if (!file) return;

            showExcelPreview(file);
        }

        // Mostrar vista previa de Excel
        async function showExcelPreview(file) {
            document.getElementById('modalFileName').textContent = file.name;
            document.getElementById('excelPreview').innerHTML = '<div class="p-4 text-center">Cargando vista previa...</div>';
            document.getElementById('excelModal').classList.remove('hidden');

            try {
                const response = await fetch('/preview-excel/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: file.path
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const tableHtml = createExcelTable(data.data);

                document.getElementById('excelPreview').innerHTML = `
            <div class="p-4">
                <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-blue-800 text-sm">
                        <i class="fas fa-info-circle mr-1"></i>
                        Archivo: ${file.name} | Ruta: ${file.path}
                    </p>
                </div>
                ${tableHtml}
            </div>
        `;

                addLog(`Vista previa cargada: ${file.name}`);

            } catch (error) {
                console.error('Error cargando vista previa:', error);
                document.getElementById('excelPreview').innerHTML = `
            <div class="p-4 text-center text-red-600">
                <i class="fas fa-exclamation-triangle mb-2"></i>
                <p>Error al cargar la vista previa</p>
                <p class="text-sm">${error.message}</p>
            </div>
        `;
                addLog(`Error en vista previa: ${error.message}`);
            }
        }

        // Descargar archivo
        async function downloadFile(fileId) {
            const file = extractedFiles.find(f => f.id === fileId);
            if (!file) return;

            showStatus(`Preparando descarga: ${file.name}`, 'info');
            addLog(`Iniciando descarga: ${file.name}`);

            try {
                const response = await fetch('/download-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: file.path
                    })
                });

                if (!response.ok) {
                    throw new Error('Error en la descarga');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showStatus(`Descarga completada: ${file.name}`, 'success');
                addLog(`Descarga completada: ${file.name}`);

            } catch (error) {
                console.error('Error en descarga:', error);
                showStatus(`Error en descarga: ${error.message}`, 'error');
                addLog(`Error en descarga: ${error.message}`);
            }
        }

        // Eliminar archivo
        async function deleteFile(fileId) {
            if (!confirm('¿Está seguro de que desea eliminar este archivo?')) return;

            const file = extractedFiles.find(f => f.id === fileId);
            if (!file) return;

            try {
                const response = await fetch('/delete-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: file.path
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                extractedFiles = extractedFiles.filter(f => f.id !== fileId);
                displayFiles();
                updateStats();
                showStatus('Archivo eliminado correctamente', 'success');
                addLog(`Archivo eliminado: ${file.name}`);

            } catch (error) {
                console.error('Error eliminando archivo:', error);
                showStatus(`Error eliminando archivo: ${error.message}`, 'error');
                addLog(`Error eliminando archivo: ${error.message}`);
            }
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('excelModal').classList.add('hidden');
        }

        // Actualizar estadísticas
        function updateStats() {
            const companySelect = document.getElementById('company-select');
            if (companySelect.selectedIndex === 0) {
                // No hay empresa seleccionada
                document.getElementById('totalFiles').textContent = '0';
                document.getElementById('totalSize').textContent = '0 MB';
                document.getElementById('successRate').textContent = '0%';
                return;
            }

            const selectedCompany = companySelect.options[companySelect.selectedIndex].text;
            const filteredFiles = extractedFiles.filter(file => file.company === selectedCompany);

            const totalFiles = filteredFiles.length;
            const totalSize = filteredFiles.reduce((sum, file) => sum + file.size, 0);
            const successRate = filteredFiles.filter(f => f.status === 'completed').length / Math.max(totalFiles, 1) * 100;

            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
            document.getElementById('successRate').textContent = Math.round(successRate) + '%';
        }

        // Mostrar/ocultar barra de progreso
        function showProgress(show) {
            document.getElementById('progressContainer').classList.toggle('hidden', !show);
        }

        // Actualizar barra de progreso
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // Mostrar estado
        function showStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            const statusClass = `p-3 rounded-lg mb-3 ${type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                    'bg-blue-100 text-blue-800'
                }`;
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';

            const statusHtml = `
        <div class="${statusClass} flex items-center gap-2">
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        </div>
    `;

            indicator.innerHTML = statusHtml;

            // Auto-hide después de 5 segundos para mensajes de éxito/info
            if (type !== 'error') {
                setTimeout(() => {
                    if (indicator.innerHTML.includes(message)) {
                        indicator.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // Agregar entrada al log
        function addLog(message) {
            const container = document.getElementById('logsContainer');
            const time = new Date().toLocaleTimeString('es-PE');

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry text-sm py-1 border-b border-gray-200 text-gray-700';
            logEntry.innerHTML = `<span class="log-time text-gray-500 mr-2">${time}</span>${message}`;

            container.insertBefore(logEntry, container.firstChild);

            // Mantener solo los últimos 50 logs
            const logs = container.querySelectorAll('.log-entry');
            if (logs.length > 50) {
                logs[logs.length - 1].remove();
            }

            // Scroll al top
            container.scrollTop = 0;
        }

        // Utilidades
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-PE', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para cambiar empresa y cargar archivos existentes
        function setupCompanyChangeListener() {
            const companySelect = document.getElementById('company-select');
            companySelect.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];

                if (selectedOption.value) {
                    addLog(`Empresa cambiada a: ${selectedOption.text}`);
                    loadExistingFiles(selectedOption.text);

                } else {
                    displayFiles();
                    updateStats();
                }
                updateAnalisisBtnState();
            });
        }

        function setupRadioButtonsListener() {
            document.querySelectorAll('input[name="rubro"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    // Guardar selección en localStorage cuando cambia el rubro
                    setTimeout(() => {
                        guardarSeleccionEnLocalStorage();
                        updateAnalisisBtnState();
                    }, 100);
                });
            });
        }

        // Vista previa de datos (sin extracción)
        async function analisis() {
            const companySelect = document.getElementById('company-select');
            const selectedOption = companySelect.options[companySelect.selectedIndex];
            const carpetaEmpresa = selectedOption.value;

            console.log(carpetaEmpresa)

            if (!selectedOption.value) {
                showStatus('Seleccione una empresa primero', 'error');
                return;
            }

            addLog(`Analizando Estados de Ratios de la empresa: ${selectedOption.text}`);

            try {
                const response = await fetch('/analisis-financieros/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        carpeta_empresa: carpetaEmpresa
                    })
                });

                const result = await response.json();

                console.log(result)

                if (response.ok && result.status === 'success') {
                    showStatus(result.message, 'success');
                    addLog(`✅ ${result.message}`);
                } else {
                    showStatus(`Error en el análisis: ${result.message || 'Error desconocido'}`, 'error');
                    addLog(`ERROR: ${result.message || 'Error de servidor'}`);
                    console.log(result)
                }

            } catch (error) {
                // Manejar errores de red o parsing de JSON
                console.error('Error de red durante el análisis:', error);
                showStatus('Error de conexión con el servidor. Verifique la red.', 'error');
                addLog(`ERROR DE CONEXIÓN: ${error}`);
            }

        }

        // Crear tabla HTML desde datos de Excel
        function createExcelTable(data) {
            if (!data || data.length === 0) return '<p>No hay datos para mostrar</p>';

            let html = '<div class="overflow-auto max-h-96"><table class="excel-table min-w-full bg-white border border-gray-200">';

            // Headers
            if (data.length > 0) {
                html += '<thead class="bg-gray-50 sticky top-0"><tr>';
                data[0].forEach(header => {
                    html += `<th class="px-4 py-2 border-b text-left font-semibold text-gray-700">${header || ''}</th>`;
                });
                html += '</tr></thead>';
            }

            // Body
            html += '<tbody>';
            for (let i = 1; i < data.length; i++) {
                html += '<tr class="hover:bg-gray-50">';
                data[i].forEach(cell => {
                    html += `<td class="px-4 py-2 border-b text-gray-600">${cell || ''}</td>`;
                });
                html += '</tr>';
            }
            html += '</tbody></table></div>';

            return html;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function () {
            addLog('Panel de control inicializado');
            updateStats();
            setupCompanyChangeListener();
        });

        // Cerrar modal al hacer clic fuera de él
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('excelModal');
            if (event.target === modal) {
                closeModal();
            }
        });

    </script>
</body>

</html>