<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Información Financiera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.5.0/css/all.css'>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f4ff',
                            100: '#e0e8ff',
                            500: '#667eea',
                            600: '#5a6fd8',
                            700: '#4c5bc6'
                        }
                    },
                    backgroundImage: {
                        'gradient-primary': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'gradient-secondary': 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                        'gradient-warning': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'gradient-info': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'gradient-success': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        'gradient-stat4': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados adicionales */
        .checkbox-item input[type="checkbox"] {
            accent-color: #667eea;
        }

        .modal {
            backdrop-filter: blur(5px);
        }

        .excel-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-500 to-purple-700 min-h-screen p-5 text-gray-800">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="header bg-white text-center mb-8 p-8 rounded-2xl shadow-xl">
            <h1
                class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
                <i class="fas fa-chart-line mr-2"></i> Panel de Control Financiero
            </h1>
            <p class="text-gray-600 text-lg">Extracción y análisis de información empresarial</p>
        </div>

        <!-- Dashboard Grid - Ahora en 2 filas -->
        <div class="flex flex-col gap-6">
            <!-- Control Panel - Ahora arriba -->
            <div class="control-panel bg-white rounded-2xl p-8 shadow-xl">
                <h2 class="section-title text-xl font-semibold mb-5 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-cogs"></i> Configuración
                </h2>

                <form id="searchForm" onsubmit="handleSearch(event)">
                    <!-- Selección de Empresa -->
                    <div class="mb-5">
                        <label for="company-select" class="form-label block text-gray-700 font-semibold mb-2 text-sm">
                            <i class="fas fa-building mr-1"></i> Empresa:
                        </label>
                        <select id="company-select"
                            class="w-full p-3 border-2 border-gray-200 rounded-xl text-gray-700 bg-gray-50 focus:outline-none focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 transition-all"
                            required>
                            <option value="">Seleccione una empresa</option>
                            <option value="ENERGIA DEL PACIFICO S.A.">ENERGIA DEL PACIFICO S.A.</option>
                            <option value="BANCO DE CREDITO DEL PERU">BANCO DE CREDITO DEL PERU</option>
                            <!-- <option value="SOUTHERN PERU COPPER CORPORATION">SOUTHERN PERU COPPER CORPORATION</option> -->
                            <option value="TELEFONICA DEL PERU S.A.A.">TELEFONICA DEL PERU S.A.A.</option>
                            <option value="COMPAÑIA DE MINAS BUENAVENTURA S.A.A.">COMPAÑIA DE MINAS BUENAVENTURA S.A.A.</option>
                            <option value="INTERCORP FINANCIAL SERVICES INC.">INTERCORP FINANCIAL SERVICES INC.</option>
                            <option value="RIMAC SEGUROS Y REASEGUROS">RIMAC SEGUROS Y REASEGUROS</option>
                            <option value="LUZ DEL SUR S.A.A.">LUZ DEL SUR S.A.A.</option>
                            <option value="VOLCAN COMPAÑIA MINERA S.A.A.">VOLCAN COMPAÑIA MINERA S.A.A.</option>
                            <option value="UNION ANDINA DE CEMENTOS S.A.A.">UNION ANDINA DE CEMENTOS S.A.A.</option>
                        </select>
                    </div>



                    <!-- Botones de Acción -->
                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <button type="submit"
                            class="btn bg-gradient-primary text-white p-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all hover:-translate-y-0.5 hover:shadow-lg">
                            <i class="fas fa-search"></i> Extraer Datos
                        </button>
                        <button type="button" id="btnAnalisis" 
                            class="btn bg-gradient-secondary text-white p-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all hover:-translate-y-0.5 hover:shadow-lg"
                            onclick="analisis()">
                            <i class="fas fa-file-excel"></i> Analisis
                        </button>
                    </div>

                </form>

                <!-- Barra de Progreso -->
                <div class="progress-container bg-gray-100 rounded-xl overflow-hidden h-2 my-5 hidden"
                    id="progressContainer">
                    <div class="progress-bar h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl w-0 transition-all"
                        id="progressBar"></div>
                </div>

                <!-- Indicador de Estado -->
                <div id="statusIndicator"></div>

                <!-- Estadísticas -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 my-6">
                    <div class="stat-card bg-gradient-warning text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="totalFiles">0</div>
                        <div class="stat-label text-sm opacity-90">Archivos Extraídos</div>
                    </div>
                    <div class="stat-card bg-gradient-info text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="totalSize">0 MB</div>
                        <div class="stat-label text-sm opacity-90">Tamaño Total</div>
                    </div>
                    <div class="stat-card bg-gradient-success text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="successRate">0%</div>
                        <div class="stat-label text-sm opacity-90">Tasa de Éxito</div>
                    </div>
                    <div class="stat-card bg-gradient-stat4 text-white p-5 rounded-xl text-center">
                        <div class="stat-number text-2xl font-bold mb-1" id="processingTime">0s</div>
                        <div class="stat-label text-sm opacity-90">Tiempo Proceso</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="mb-5">
                    <label class="form-label block text-gray-700 font-semibold mb-2 text-sm">
                        <i class="fas fa-terminal mr-1"></i> Registro de Actividad:
                    </label>
                    <div class="logs-container bg-gray-50 rounded-xl p-4 max-h-40 overflow-y-auto" id="logsContainer">
                        <div class="log-entry text-sm py-1 border-b border-gray-200 text-gray-700">
                            <span class="log-time text-gray-500 mr-2">12:00:00</span>
                            Sistema iniciado correctamente
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel - Ahora abajo -->
            <div class="results-panel bg-white rounded-2xl p-8 shadow-xl min-h-[500px]">
                <h2 class="section-title text-xl font-semibold mb-5 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-folder-open"></i> Archivos Extraídos
                </h2>

                <div id="filesList" class="file-list">
                    <!-- Los archivos se mostrarán aquí dinámicamente -->
                    <div class="text-center py-16 text-gray-500">
                        <i class="fas fa-inbox text-5xl mb-5 opacity-50"></i>
                        <p>No hay archivos extraídos aún</p>
                        <p class="text-sm mt-2">Seleccione una empresa y configure los parámetros de extracción</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Vista Previa de Excel -->
    <div id="excelModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div
            class="modal-content bg-white p-8 rounded-2xl shadow-2xl absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-6xl max-h-[90vh] overflow-auto">
            <div class="modal-header flex justify-between items-center mb-5 pb-3 border-b border-gray-200">
                <h3 class="text-xl font-semibold"><i class="fas fa-file-excel mr-2"></i> Vista Previa - <span
                        id="modalFileName"></span></h3>
                <button
                    class="close-modal bg-transparent border-none text-gray-500 text-2xl cursor-pointer w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-100 hover:text-gray-700 transition-colors"
                    onclick="closeModal()">&times;</button>
            </div>
            <div class="excel-preview overflow-auto max-h-96 border border-gray-200 rounded-lg" id="excelPreview">
                <!-- Contenido del Excel se cargará aquí -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let extractedFiles = [];
        let currentExtractionId = null;
        let processingStartTime = null;
        let progressInterval = null;
        let currentDownloadPath = '';

        // Función principal de extracción
        function handleSearch(event) {
            event.preventDefault();

            const formData = getFormData();
            if (!validateFormData(formData)) return;

            startExtraction(formData);
        }

        // Recopilar datos del formulario
        function getFormData() {
            const companySelect = document.getElementById('company-select');
            const selectedOption = companySelect.options[companySelect.selectedIndex];

            return {
                company: companySelect.value,
                companyName: selectedOption.text,
            };
        }

        function updateAnalisisBtnState() {
            const companySelect = document.getElementById('company-select');
            const btnAnalisis = document.getElementById('btnAnalisis');
            console.log('Archivos extraídos:',extractedFiles.filter(f => f.company === companySelect.value).length);
            btnAnalisis.disabled = extractedFiles.filter(f => f.company === companySelect.value).length !== 5;
            btnAnalisis.classList.toggle('opacity-50', extractedFiles.filter(f => f.company === companySelect.value).length !== 5);
        }

  

        // Validar datos del formulario
        function validateFormData(data) {
            if (!data.company) {
                showStatus('Por favor seleccione una empresa', 'error');
                return false;
            }
            return true;
        }

        // Iniciar proceso de extracción
        function startExtraction(data) {
            processingStartTime = Date.now();
            currentExtractionId = generateId();

            showProgress(true);
            updateProgress(0);
            showStatus('Iniciando extracción de datos...', 'info');
            addLog('Iniciando extracción para: ' + data.companyName);

            // Configurar path de descarga esperado
            const companyClean = data.companyName.replace(/[^a-zA-Z0-9\s\-_]/g, '').replace(/\s+/g, '_');
            currentDownloadPath = `descargas_smv/${companyClean}`;
            if (!currentDownloadPath.exists) {
                addLog('Error: Ruta de descarga inválida');
            }
            console.log('Path de descarga configurado:', currentDownloadPath);

            // Iniciar monitoreo de progreso
            startProgressMonitoring();

            // Llamar a la función Django via AJAX
            callDjangoExtraction(data);
        }

        // Monitoreo de progreso en tiempo real
        function startProgressMonitoring() {
            let progress = 0;
            const progressSteps = [10, 25, 40, 55, 70, 85];
            let currentStep = 0;

            progressInterval = setInterval(() => {
                if (currentStep < progressSteps.length) {
                    progress = progressSteps[currentStep];
                    updateProgress(progress);

                    // Mensajes de progreso
                    const messages = [
                        'Conectando con SMV...',
                        'Navegando a la página de empresas...',
                        'Buscando empresa...',
                        'Accediendo a información financiera...',
                        'Descargando archivos...',
                        'Procesando documentos...'
                    ];

                    if (currentStep < messages.length) {
                        showStatus(messages[currentStep], 'info');
                        addLog(messages[currentStep]);
                    }

                    currentStep++;
                }

                // Verificar archivos en tiempo real
                checkForNewFiles();

            }, 1000); // Verificar cada 1 segundos
        }

        // Verificar nuevos archivos en la carpeta
        async function checkForNewFiles() {
            if (!currentDownloadPath) return;

            try {
                const response = await fetch('/verificar-archivos/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        path: currentDownloadPath
                    })
                });

                const data = await response.json();

                if (data.archivos) {
                    const companySelect = document.getElementById('company-select');
                    const selectedCompany = companySelect.options[companySelect.selectedIndex].text;

                    data.archivos.forEach(archivo => {
                        const exists = extractedFiles.some(f => f.path === archivo.ruta);
                        if (!exists) {
                            const file = {
                                id: generateId(),
                                name: archivo.nombre,
                                type: 'excel',
                                size: archivo.tamaño || 0,
                                date: new Date(archivo.fecha || Date.now()),
                                company: selectedCompany,
                                format: 'excel',
                                status: 'completed',
                                path: archivo.ruta,
                                year: archivo.año || extractYearFromFilename(archivo.nombre)
                            };

                            extractedFiles.push(file);
                            addLog(`Archivo encontrado: ${file.name}`);
                            displayFiles();
                            updateStats();
                        }
                    });
                }

            } catch (error) {
                console.error('Error verificando archivos:', error);
            }
        }

        // Extraer año del nombre del archivo
        function extractYearFromFilename(filename) {
            const yearMatch = filename.match(/(\d{4})/);
            return yearMatch ? parseInt(yearMatch[1]) : null;
        }

        // Llamar a la función Django
        function callDjangoExtraction(data) {
            fetch('/descargar-datos-financieros/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    empresa_nombre: data.companyName,
                    anios: data.anios
                })
            })
                .then(response => response.json())
                .then(resultado => {
                    if (resultado.error) {
                        throw new Error(resultado.error);
                    }
                    console.log('Extracción completada:', resultado);
                    finishExtraction(data, resultado);
                })
                .catch(error => {
                    console.error('Error en la extracción:', error);
                    showStatus('Error en la extracción: ' + error.message, 'error');
                    addLog('Error: ' + error.message);
                    showProgress(false);
                    clearInterval(progressInterval);
                });
        }

        // Obtener token CSRF
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Finalizar extracción
        function finishExtraction(data, resultado) {
            clearInterval(progressInterval);

            const processingTime = Math.round((Date.now() - processingStartTime) / 1000);

            // Procesar archivos del resultado
            if (resultado.archivos && resultado.archivos.length > 0) {
                resultado.archivos.forEach((archivo) => {
                    const file = {
                        id: generateId(),
                        name: archivo.nombre,
                        type: archivo.tipo || 'excel',
                        size: archivo.tamaño || 0,
                        date: new Date(archivo.fecha || Date.now()),
                        company: data.companyName,
                        format: 'excel',
                        status: 'completed',
                        path: archivo.ruta || '',
                        year: archivo.año || extractYearFromFilename(archivo.nombre)
                    };

                    // Evitar duplicados
                    const exists = extractedFiles.some(f => f.path === file.path);
                    if (!exists) {
                        extractedFiles.push(file);
                    }
                });
            }

            updateProgress(100);
            showStatus(`Extracción completada. ${extractedFiles.filter(f => f.company === data.companyName).length} archivos extraídos exitosamente.`, 'success');
            addLog(`Proceso completado en ${processingTime} segundos`);

            // Actualizar estadísticas
            updateStats();

            // Mostrar archivos
            displayFiles();

            // Ocultar progreso después de un momento
            setTimeout(() => showProgress(false), 2000);

            // Actualizar tiempo de procesamiento
            document.getElementById('processingTime').textContent = processingTime + 's';
        }

        // Cargar archivos existentes de una empresa
        async function loadExistingFiles(companyName) {
            const companyClean = companyName.replace(/[^a-zA-Z0-9\s\-_]/g, '').replace(/\s+/g, '_');
            currentDownloadPath = `descargas_smv/${companyClean}`;

            try {
                addLog(`Verificando archivos existentes para: ${companyName}`);

                const response = await fetch('/verificar-archivos/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        path: currentDownloadPath
                    })
                });

                const data = await response.json();

                if (data.archivos && data.archivos.length > 0) {
                    // Limpiar archivos existentes de esta empresa
                    extractedFiles = extractedFiles.filter(f => f.company !== companyName);

                    data.archivos.forEach(archivo => {
                        const file = {
                            id: generateId(),
                            name: archivo.nombre,
                            type: 'excel',
                            size: archivo.tamaño || 0,
                            date: new Date(archivo.fecha || Date.now()),
                            company: companyName,
                            format: 'excel',
                            status: 'completed',
                            path: archivo.ruta,
                            year: archivo.año || extractYearFromFilename(archivo.nombre)
                        };

                        extractedFiles.push(file);
                    });

                    addLog(`${data.archivos.length} archivos encontrados para ${companyName}`);
                } else {
                    addLog(`No se encontraron archivos para ${companyName}`);
                }

                displayFiles();
                updateStats();

            } catch (error) {
                console.error('Error cargando archivos existentes:', error);
                addLog('Error al cargar archivos existentes: ' + error.message);
            }
        }

        // Mostrar archivos en la interfaz
        function displayFiles() {
            const container = document.getElementById('filesList');

            if (extractedFiles.length === 0) {
                container.innerHTML = `
            <div class="text-center py-16 text-gray-500">
                <i class="fas fa-inbox text-5xl mb-5 opacity-50"></i>
                <p>No hay archivos extraídos aún</p>
                <p class="text-sm mt-2">Seleccione una empresa y configure los parámetros de extracción</p>
            </div>
        `;
                return;
            }

            // Filtrar archivos por la empresa seleccionada
            const companySelect = document.getElementById('company-select');
            const selectedCompany = companySelect.options[companySelect.selectedIndex].text;
            const filteredFiles = extractedFiles.filter(file => file.company === selectedCompany);

            if (filteredFiles.length === 0) {
                container.innerHTML = `
            <div class="text-center py-16 text-gray-500">
                <i class="fas fa-inbox text-5xl mb-5 opacity-50"></i>
                <p>No hay archivos para ${selectedCompany}</p>
                <p class="text-sm mt-2">Realice una extracción para esta empresa</p>
            </div>
        `;
                return;
            }

            // Ordenar archivos por año (más reciente primero)
            const sortedFiles = filteredFiles.sort((a, b) => (b.year || 0) - (a.year || 0));

            const filesHtml = sortedFiles.map(file => `
        <div class="file-item bg-gray-50 rounded-lg p-4 mb-3 flex justify-between items-center">
            <div class="file-info flex items-center gap-3">
                <div class="file-icon text-green-600 text-2xl">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="file-details">
                    <h4 class="font-semibold text-gray-800">${file.name}</h4>
                    <p class="text-sm text-gray-600">
                        ${file.company} • ${formatFileSize(file.size)} • ${formatDate(file.date)}
                        ${file.year ? ` • Año ${file.year}` : ''}
                    </p>
                    <p class="text-xs text-gray-500">${file.path}</p>
                </div>
            </div>
            <div class="file-actions flex gap-2">
                <button class="btn bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600 transition-colors" onclick="previewFile('${file.id}')">
                    <i class="fas fa-eye"></i> Ver
                </button>
                <button class="btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors" onclick="downloadFile('${file.id}')">
                    <i class="fas fa-download"></i> Descargar
                </button>
                <button class="btn bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition-colors" onclick="deleteFile('${file.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');

            container.innerHTML = filesHtml;
        }

        // Vista previa de archivo
        function previewFile(fileId) {
            const file = extractedFiles.find(f => f.id === fileId);
            if (!file) return;

            showExcelPreview(file);
        }

        // Mostrar vista previa de Excel
        async function showExcelPreview(file) {
            document.getElementById('modalFileName').textContent = file.name;
            document.getElementById('excelPreview').innerHTML = '<div class="p-4 text-center">Cargando vista previa...</div>';
            document.getElementById('excelModal').classList.remove('hidden');

            try {
                const response = await fetch('/preview-excel/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: file.path
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const tableHtml = createExcelTable(data.data);

                document.getElementById('excelPreview').innerHTML = `
            <div class="p-4">
                <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-blue-800 text-sm">
                        <i class="fas fa-info-circle mr-1"></i>
                        Archivo: ${file.name} | Ruta: ${file.path}
                    </p>
                </div>
                ${tableHtml}
            </div>
        `;

                addLog(`Vista previa cargada: ${file.name}`);

            } catch (error) {
                console.error('Error cargando vista previa:', error);
                document.getElementById('excelPreview').innerHTML = `
            <div class="p-4 text-center text-red-600">
                <i class="fas fa-exclamation-triangle mb-2"></i>
                <p>Error al cargar la vista previa</p>
                <p class="text-sm">${error.message}</p>
            </div>
        `;
                addLog(`Error en vista previa: ${error.message}`);
            }
        }

        // Descargar archivo
        async function downloadFile(fileId) {
            const file = extractedFiles.find(f => f.id === fileId);
            if (!file) return;

            showStatus(`Preparando descarga: ${file.name}`, 'info');
            addLog(`Iniciando descarga: ${file.name}`);

            try {
                const response = await fetch('/download-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: file.path
                    })
                });

                if (!response.ok) {
                    throw new Error('Error en la descarga');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showStatus(`Descarga completada: ${file.name}`, 'success');
                addLog(`Descarga completada: ${file.name}`);

            } catch (error) {
                console.error('Error en descarga:', error);
                showStatus(`Error en descarga: ${error.message}`, 'error');
                addLog(`Error en descarga: ${error.message}`);
            }
        }

        // Eliminar archivo
        async function deleteFile(fileId) {
            if (!confirm('¿Está seguro de que desea eliminar este archivo?')) return;

            const file = extractedFiles.find(f => f.id === fileId);
            if (!file) return;

            try {
                const response = await fetch('/delete-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: file.path
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                extractedFiles = extractedFiles.filter(f => f.id !== fileId);
                displayFiles();
                updateStats();
                showStatus('Archivo eliminado correctamente', 'success');
                addLog(`Archivo eliminado: ${file.name}`);

            } catch (error) {
                console.error('Error eliminando archivo:', error);
                showStatus(`Error eliminando archivo: ${error.message}`, 'error');
                addLog(`Error eliminando archivo: ${error.message}`);
            }
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('excelModal').classList.add('hidden');
        }

        // Actualizar estadísticas
        function updateStats() {
            const companySelect = document.getElementById('company-select');
            if (companySelect.selectedIndex === 0) {
                // No hay empresa seleccionada
                document.getElementById('totalFiles').textContent = '0';
                document.getElementById('totalSize').textContent = '0 MB';
                document.getElementById('successRate').textContent = '0%';
                return;
            }

            const selectedCompany = companySelect.options[companySelect.selectedIndex].text;
            const filteredFiles = extractedFiles.filter(file => file.company === selectedCompany);

            const totalFiles = filteredFiles.length;
            const totalSize = filteredFiles.reduce((sum, file) => sum + file.size, 0);
            const successRate = filteredFiles.filter(f => f.status === 'completed').length / Math.max(totalFiles, 1) * 100;

            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
            document.getElementById('successRate').textContent = Math.round(successRate) + '%';
        }

        // Mostrar/ocultar barra de progreso
        function showProgress(show) {
            document.getElementById('progressContainer').classList.toggle('hidden', !show);
        }

        // Actualizar barra de progreso
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // Mostrar estado
        function showStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            const statusClass = `p-3 rounded-lg mb-3 ${type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                    'bg-blue-100 text-blue-800'
                }`;
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';

            const statusHtml = `
        <div class="${statusClass} flex items-center gap-2">
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        </div>
    `;

            indicator.innerHTML = statusHtml;

            // Auto-hide después de 5 segundos para mensajes de éxito/info
            if (type !== 'error') {
                setTimeout(() => {
                    if (indicator.innerHTML.includes(message)) {
                        indicator.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // Agregar entrada al log
        function addLog(message) {
            const container = document.getElementById('logsContainer');
            const time = new Date().toLocaleTimeString('es-PE');

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry text-sm py-1 border-b border-gray-200 text-gray-700';
            logEntry.innerHTML = `<span class="log-time text-gray-500 mr-2">${time}</span>${message}`;

            container.insertBefore(logEntry, container.firstChild);

            // Mantener solo los últimos 50 logs
            const logs = container.querySelectorAll('.log-entry');
            if (logs.length > 50) {
                logs[logs.length - 1].remove();
            }

            // Scroll al top
            container.scrollTop = 0;
        }

        // Utilidades
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-PE', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para cambiar empresa y cargar archivos existentes
        function setupCompanyChangeListener() {
            const companySelect = document.getElementById('company-select');
            companySelect.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
             
                if (selectedOption.value) {
                    addLog(`Empresa cambiada a: ${selectedOption.text}`);
                    loadExistingFiles(selectedOption.text);
                   
                } else {
                    displayFiles();
                    updateStats();
                }
                updateAnalisisBtnState();
            });
        }

        // Vista previa de datos (sin extracción)
        async function analisis() {
            const companySelect = document.getElementById('company-select');
            const selectedOption = companySelect.options[companySelect.selectedIndex];
            const carpetaEmpresa = selectedOption.value;

            console.log(carpetaEmpresa)

            if (!selectedOption.value) {
                showStatus('Seleccione una empresa primero', 'error');
                return;
            }

            addLog(`Analizando Estados de Ratios de la empresa: ${selectedOption.text}`);

            try {
                const response = await fetch('/analisis-financieros/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        carpeta_empresa: carpetaEmpresa 
                    })
                });

                const result = await response.json();

                console.log(result)

                if (response.ok && result.status === 'success') {
                    showStatus(result.message, 'success');
                    addLog(`✅ ${result.message}`);
                } else {
                    showStatus(`Error en el análisis: ${result.message || 'Error desconocido'}`, 'error');
                    addLog(`ERROR: ${result.message || 'Error de servidor'}`);
                    console.log(result)
                }

            } catch (error) {
                // Manejar errores de red o parsing de JSON
                console.error('Error de red durante el análisis:', error);
                showStatus('Error de conexión con el servidor. Verifique la red.', 'error');
                addLog(`ERROR DE CONEXIÓN: ${error}`);
            }
            
        }

        // Crear tabla HTML desde datos de Excel
        function createExcelTable(data) {
            if (!data || data.length === 0) return '<p>No hay datos para mostrar</p>';

            let html = '<div class="overflow-auto max-h-96"><table class="excel-table min-w-full bg-white border border-gray-200">';

            // Headers
            if (data.length > 0) {
                html += '<thead class="bg-gray-50 sticky top-0"><tr>';
                data[0].forEach(header => {
                    html += `<th class="px-4 py-2 border-b text-left font-semibold text-gray-700">${header || ''}</th>`;
                });
                html += '</tr></thead>';
            }

            // Body
            html += '<tbody>';
            for (let i = 1; i < data.length; i++) {
                html += '<tr class="hover:bg-gray-50">';
                data[i].forEach(cell => {
                    html += `<td class="px-4 py-2 border-b text-gray-600">${cell || ''}</td>`;
                });
                html += '</tr>';
            }
            html += '</tbody></table></div>';

            return html;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function () {
            addLog('Panel de control inicializado');
            updateStats();
            setupCompanyChangeListener();
        });

        // Cerrar modal al hacer clic fuera de él
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('excelModal');
            if (event.target === modal) {
                closeModal();
            }
        });
 
    </script>
</body>

</html>